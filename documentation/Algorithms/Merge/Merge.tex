\documentclass[../Algorithms.tex]{subfiles}

\begin{document}
    \section{Semistructured Merge}

    \subsection{Early Concepts}

    \begin{enumerate}
        \item Every node's origin is set to UNKNOWN beforehand
    \end{enumerate}

    \subsection{Merge Algorithms}

    \begin{algorithm}[H]
        \caption{Merge Files}

        \KwIn{l, b, r, o}

        \BlankLine
        \SetKwFunction{ftt}{fileToTree}
        \SetKwFunction{mt}{mergeTrees}
        \SetKwFunction{gah}{getActiveHandlers}
        \SetKwFunction{ttt}{treeToText}

        \uIf{$l.content = b.content$}{
            $o.content \leftarrow r.content$\;
        }
        \uElseIf{$b.content = r.content \lor l.content = r.content$}{
            $o.content \leftarrow l.content$\;
        }
        \Else{
            $L \leftarrow \ftt{l}$\;
            $B \leftarrow \ftt{b}$\;
            $R \leftarrow \ftt(r)$\;

            \BlankLine
            $M \leftarrow \mt{L, B, R}$\;

            \BlankLine
            $H \leftarrow \gah{}$\;
            \ForEach{$h \in H$}{
                $h.handle(M)$\;
            }

            \BlankLine
            $o.content \leftarrow \ttt{M}$\;
        }
    \end{algorithm}

    \SetKwFunction{mn}{mergeNodes}
    \SetKwFunction{rdn}{removeDeletedNodes}
    \SetKwFunction{rtmol}{runTextualMergeOnLeaves}

    \begin{algorithm}[H]
        \caption{Merge Trees}

        \KwIn{L, B, R}
        \KwOut{result of merging left, base and right trees}

        \BlankLine

        $L.origin = LEFT$\;
        $B.origin = BASE$\;
        $R.origin = RIGHT$\;

        \BlankLine
        $LB \leftarrow \mn{L, B}$\;
        $M \leftarrow \mn{LB, R}$\;

        \BlankLine
        $D_L \leftarrow \{ b \in B \mid (\lnot \exists l \in L) (l.id = b.id) \}$\;
        $D_R \leftarrow \{ b \in B \mid (\lnot \exists r \in R) (r.id = b.id) \}$\;
        $D \leftarrow D_{L} \cap D_{R}$\;

        \BlankLine
        \ForEach{$d \in D$}{
            \rn{d, M}\;
        }

        \BlankLine
        \rtmol{M}\;

        \BlankLine
        \KwRet{M}\;
    \end{algorithm}

    \SetKwFunction{tm}{textualMerge}

    \begin{algorithm}[H]
        \caption{Run Textual Merge On Leaves}

        \KwIn{T}

        \BlankLine
        \ForEach{$t \in T.children$}{
            \rtmol{t}\;
        }

        \BlankLine
        \If{$T.children = \emptyset \land SEPARATOR \in T.body$}{
            $l, b, r \leftarrow split(T.body, SEPARATOR)$\;
            $l \leftarrow l - MARKER$\;
            $T.body \leftarrow \tm{l, b, r}$\;
        }
    \end{algorithm}

    \begin{algorithm}[H]
        \caption{Merge Nodes}

        \KwIn{A, B}
        \KwOut{result of merging nodes A and B}

        \BlankLine
        \SetKwFunction{mc}{markContributions}

        \lIf{A = null}{ \KwRet{B} }
        \lIf{B = null}{ \KwRet{A} }
        \lIf{$A.type \neq B.type \lor A.id \neq B.id$}{
            \KwRet{null}
        }

        \BlankLine
        $M.id \leftarrow A.id$\;
        $M.type \leftarrow A.type$\;
        $M.origin \leftarrow B.origin$\;
        $M.children \leftarrow \emptyset$\;

        \BlankLine
        \uIf{$A.children = \emptyset \land B.children = \emptyset$}{
            \uIf{$MARKER \in A.body$}{
                $M.body \leftarrow A.body + B.body$\;
            }
            \uElseIf{$A.origin = LEFT \land B.origin = BASE$}{
                $M.body \leftarrow MARKER + A.body + SEPARATOR + B.body + SEPARATOR$\;
            }
            \uElseIf{A.origin = LEFT}{
                $M.body \leftarrow MARKER + A.body + SEPARATOR + SEPARATOR + B.body$\;
            }
            \Else{
                $M.body \leftarrow MARKER + SEPARATOR + A.body + SEPARATOR + B.body$\;
            }

            \BlankLine
            \KwRet{M}\;
        }
        \ElseIf{$A.children \neq \emptyset \land B.children \neq \emptyset$}{
            \ForEach{$b \in B.children$}{
                $a \leftarrow find(a \in A.children \rightarrow a.type = b.type \land a.id = b.id)$\;

                \BlankLine
                \lIf{a.origin = UNKNOWN}{
                    $a.origin \leftarrow A.origin$
                }
                \lIf{b.origin = UNKNOWN}{
                    $b.origin \leftarrow B.origin$
                }

                \BlankLine
                $M.children \leftarrow M.children \cup \mn{a, b, step}$\;
            }

            \BlankLine
            \ForEach{$a \in A.children$}{
                $b \leftarrow find(b \in B.children \rightarrow a.type = b.type \land a.id = b.id)$\;

                \BlankLine
                \lIf{a.origin = UNKNOWN}{
                    $a.origin \leftarrow A.origin$
                }

                \BlankLine
                \lIf{b = null}{
                    $M.children \leftarrow M.children \cup a$
                }
            }

            \BlankLine
            \KwRet{M}\;
        }

        \BlankLine
        \KwRet{null};
    \end{algorithm}
\end{document}